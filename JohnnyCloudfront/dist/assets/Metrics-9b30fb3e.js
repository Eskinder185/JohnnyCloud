var M=Object.defineProperty;var L=(s,t,a)=>t in s?M(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a;var v=(s,t,a)=>(L(s,typeof t!="symbol"?t+"":t,a),a);import{j as e,_ as p}from"./index-d7f71f52.js";import{r as c}from"./react-vendor-cf778ffd.js";import{H as P}from"./Heading-7a6263f9.js";import{B as $}from"./Button-28541fea.js";import{E as O}from"./ErrorBoundary-08a630ee.js";function N({children:s,className:t="",variant:a="default"}){return e.jsx("div",{className:`min-h-screen py-8 ${t}`,children:e.jsx("div",{className:"max-w-6xl mx-auto px-4",children:s})})}function g({className:s=""}){return e.jsx("div",{className:`animate-pulse rounded-md bg-white/5 ${s}`})}function R(){return localStorage.getItem("id_token")||localStorage.getItem("access_token")||""}function U(){const s=R();if(!s)return!1;try{const t=JSON.parse(atob(s.split(".")[1]));return Date.now()/1e3<t.exp}catch{return!1}}function w(s){return s==null||Number.isNaN(s)?"—":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(s)}function ae(s,t,a,n,l){if(t===0)return`${a} costs: new resource detected`;const i=(s-t)/t*100,m=i>0?`+${i.toFixed(0)}%`:`${i.toFixed(0)}%`;let o=`${a} costs ${m} vs baseline`;return n&&(o+=`, largely from ${n}`),l&&(o+=` in ${l}`),o}function re(s){switch(s.toLowerCase()){case"high":return"text-red-400 bg-red-500/20";case"medium":return"text-amber-400 bg-amber-500/20";case"low":return"text-green-400 bg-green-500/20";default:return"text-slate-400 bg-slate-500/20"}}function ie(s){return s>=7?"High":s>=4?"Medium":"Low"}function ne(s){const t=s.toLowerCase();return t.includes("high")||t.includes("critical")?"High":t.includes("medium")||t.includes("moderate")?"Medium":"Low"}function I(s,t,a){const n=[a.map(o=>o.label).join(","),...s.map(o=>a.map(u=>{const x=o[u.key];return typeof x=="string"&&(x.includes(",")||x.includes('"'))?`"${x.replace(/"/g,'""')}"`:x??""}).join(","))].join(`
`),l=new Blob([n],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),m=URL.createObjectURL(l);i.setAttribute("href",m),i.setAttribute("download",t),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i)}function le(s){const t=[{key:"timestamp",label:"Timestamp"},{key:"period",label:"Period"},{key:"service",label:"Service"},{key:"resource",label:"Resource"},{key:"region",label:"Region"},{key:"baseline_amount",label:"Baseline Amount"},{key:"current_amount",label:"Current Amount"},{key:"impact_percent",label:"Impact %"},{key:"driver_resource",label:"Driver Resource"},{key:"notes",label:"Notes"}],a=`johnnycloud_anomalies_${new Date().toISOString().slice(0,19).replace(/:/g,"")}.csv`;I(s,a,t)}function ce(s){const t=[{key:"timestamp_first_seen",label:"First Seen"},{key:"timestamp_last_seen",label:"Last Seen"},{key:"provider",label:"Provider"},{key:"severity",label:"Severity"},{key:"title",label:"Title"},{key:"account",label:"Account"},{key:"region",label:"Region"},{key:"resource_id",label:"Resource ID"},{key:"status",label:"Status"},{key:"link",label:"Link"}],a=`johnnycloud_findings_${new Date().toISOString().slice(0,19).replace(/:/g,"")}.csv`;I(s,a,t)}function z({title:s="Content Unavailable",message:t="Unable to load content at this time.",showRetry:a=!0,onRetry:n}){return e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx("div",{className:"mb-4",children:e.jsx("svg",{className:"w-16 h-16 text-white/30 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:s}),e.jsx("p",{className:"text-white/60 mb-6 max-w-md",children:t}),a&&n&&e.jsx("button",{onClick:n,className:"px-4 py-2 bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg transition-colors",children:"Try Again"})]})}function H({onRetry:s}){return e.jsx(z,{title:"Metrics Unavailable",message:"Unable to load metrics data. This might be due to API configuration or network issues.",onRetry:s})}class V{constructor(){v(this,"cache",new Map);v(this,"defaultTTL",5*60*1e3)}set(t,a,n=this.defaultTTL){this.cache.set(t,{data:a,timestamp:Date.now(),ttl:n})}get(t){const a=this.cache.get(t);return a?Date.now()-a.timestamp>a.ttl?(this.cache.delete(t),null):a.data:null}has(t){return this.get(t)!==null}delete(t){this.cache.delete(t)}clear(){this.cache.clear()}generateKey(t,a){const n=(a==null?void 0:a.method)||"GET",l=a!=null&&a.body?JSON.stringify(a.body):"";return`${n}:${t}:${l}`}}const _=new V;async function B(s,t,a){const n=_.generateKey(s,t),l=_.get(n);if(l)return console.log("🚀 Cache hit for:",s),new Response(JSON.stringify(l),{status:200,statusText:"OK",headers:{"Content-Type":"application/json"}});console.log("🌐 Fetching from API:",s);try{const i=await fetch(s,t);if(i.ok){const o=await i.clone().json();_.set(n,o,a)}return i}catch(i){throw console.error("API fetch error:",i),i}}const K=c.lazy(()=>p(()=>import("./SpendTrendChart-7db454d8.js"),["assets/SpendTrendChart-7db454d8.js","assets/index-d7f71f52.js","assets/react-vendor-cf778ffd.js","assets/index-b27ac1ba.css","assets/chart-vendor-0831e0ff.js","assets/Heading-7a6263f9.js","assets/Button-28541fea.js","assets/ErrorBoundary-08a630ee.js"])),G=c.lazy(()=>p(()=>import("./SecurityFindingsChart-b6c85486.js"),["assets/SecurityFindingsChart-b6c85486.js","assets/index-d7f71f52.js","assets/react-vendor-cf778ffd.js","assets/index-b27ac1ba.css","assets/chart-vendor-0831e0ff.js"])),J=c.lazy(()=>p(()=>import("./SavingsProgressTracker-7b4bcbae.js"),["assets/SavingsProgressTracker-7b4bcbae.js","assets/index-d7f71f52.js","assets/react-vendor-cf778ffd.js","assets/index-b27ac1ba.css","assets/Heading-7a6263f9.js","assets/Button-28541fea.js","assets/ErrorBoundary-08a630ee.js"])),W=c.lazy(()=>p(()=>import("./AnomaliesList-3eef63c9.js"),["assets/AnomaliesList-3eef63c9.js","assets/index-d7f71f52.js","assets/react-vendor-cf778ffd.js","assets/index-b27ac1ba.css","assets/dateUtils-ee9ad50a.js","assets/Heading-7a6263f9.js","assets/Button-28541fea.js","assets/ErrorBoundary-08a630ee.js"])),q=c.lazy(()=>p(()=>import("./SecurityFindingsList-6f09c75c.js"),["assets/SecurityFindingsList-6f09c75c.js","assets/index-d7f71f52.js","assets/react-vendor-cf778ffd.js","assets/index-b27ac1ba.css","assets/Heading-7a6263f9.js","assets/Button-28541fea.js","assets/ErrorBoundary-08a630ee.js"]));function Q(){var k;const[s,t]=c.useState(null),[a,n]=c.useState(!0),[l,i]=c.useState(null),[m,o]=c.useState("7d"),[u,x]=c.useState("both"),S=async()=>{var d,A,F,D,C;try{n(!0),i(null);const b=R();if(!b||!U()){i("not_authenticated");return}const E="https://4z2t2pj4r4.execute-api.us-east-1.amazonaws.com/metrics";console.log("Fetching metrics from:",E),console.log("Time range:",m,"Data source:",u);const h=await B(E,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b}`,Accept:"application/json"},body:JSON.stringify({timeRange:m,dataSource:u})},2*60*1e3);if(console.log("Response status:",h.status,h.statusText),!h.ok){let j=`HTTP ${h.status}: ${h.statusText}`;try{const T=await h.json();j=T.error||T.message||j}catch{}console.error("API Error:",j),i(j);return}const r=await h.json();if(console.log("Received data:",r),console.log("Anomalies structure:",r.anomalies),console.log("SecurityFindings structure:",r.securityFindings),console.log("Meta structure:",r.meta),console.log("Security Hub enabled:",(d=r.meta)==null?void 0:d.securityHubEnabled),!r||typeof r!="object")throw new Error("Invalid data format received from API");const f={cards:r.cards||{mtdSpendUSD:0,forecastUSD:0,anomalies30d:0,guardDutyFindings7d:0,secHubFailedControls7d:0,iamUsersWithoutMFA:0,iamKeysOver90d:0,publicBuckets:0,openSgRules:0},charts:r.charts||{dailySpend7d:[],topServicesMTD:[],securityFindings7d:[]},anomalies:Array.isArray(r.anomalies)?r.anomalies:Array.isArray((A=r.anomalies)==null?void 0:A.items)?r.anomalies.items:Array.isArray((F=r.anomalies)==null?void 0:F.data)?r.anomalies.data:[],securityFindings:Array.isArray(r.securityFindings)?r.securityFindings:Array.isArray((D=r.securityFindings)==null?void 0:D.items)?r.securityFindings.items:Array.isArray((C=r.securityFindings)==null?void 0:C.data)?r.securityFindings.data:[],savings:r.savings||{totalSavings:0,optimizationCount:0,targetSavings:0,topActions:[]},meta:r.meta||{costExplorerReady:!1,securityHubEnabled:!1,guardDutyEnabled:!1}};console.log("Validated anomalies:",f.anomalies),console.log("Validated securityFindings:",f.securityFindings),t(f)}catch(b){console.error("Fetch error:",b),i(b instanceof Error?b.message:"Failed to fetch metrics")}finally{n(!1)}};c.useEffect(()=>{S()},[m,u]);const y=()=>{S()};return a?e.jsx(N,{variant:"none",children:e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})})}):l?e.jsx(N,{variant:"none",children:e.jsx(H,{onRetry:y})}):e.jsxs(N,{variant:"none",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-6",children:[e.jsx(P,{className:"text-3xl sm:text-4xl",children:"Metrics"}),e.jsxs("div",{className:"ml-auto flex gap-2",children:[e.jsxs("select",{value:m,onChange:d=>o(d.target.value),className:"px-3 py-1 bg-white/10 border border-white/20 rounded text-sm text-white",children:[e.jsx("option",{value:"7d",children:"Last 7 days"}),e.jsx("option",{value:"30d",children:"Last 30 days"}),e.jsx("option",{value:"mtd",children:"Month to date"}),e.jsx("option",{value:"qtd",children:"Quarter to date"})]}),e.jsx($,{onClick:y,children:"Refresh"})]})]}),s&&!s.meta.costExplorerReady&&e.jsx("div",{className:"mb-4 p-4 bg-yellow-500/20 border border-yellow-500/30 rounded-lg",children:e.jsx("div",{className:"text-yellow-200 text-sm",children:"Cost Explorer is still backfilling. Values may be zero for ~24h."})}),s&&!s.meta.securityHubEnabled&&e.jsx("div",{className:"mb-4 p-4 bg-orange-500/20 border border-orange-500/30 rounded-lg",children:e.jsx("div",{className:"text-orange-200 text-sm",children:"Security Hub is disabled. Enable it in us-east-1 to see failed controls."})}),s&&!s.meta.guardDutyEnabled&&e.jsx("div",{className:"mb-4 p-4 bg-red-500/20 border border-red-500/30 rounded-lg",children:e.jsx("div",{className:"text-red-200 text-sm",children:"Enable GuardDuty in us-east-1."})}),l==="not_authenticated"&&e.jsx("div",{className:"mb-6 p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg",children:e.jsx("p",{className:"text-amber-300 text-sm",children:"Please log in to view your metrics."})}),l&&l!=="not_authenticated"&&e.jsxs("div",{className:"mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-lg",children:[e.jsxs("p",{className:"text-red-300 text-sm",children:["Error loading metrics: ",l]}),e.jsx("button",{onClick:y,className:"mt-2 px-3 py-1 bg-red-500/20 text-red-300 rounded text-sm hover:bg-red-500/30",children:"Retry"})]}),a&&e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur",children:[e.jsx(g,{className:"h-5 w-40"}),e.jsx(g,{className:"mt-2 h-8 w-24"}),e.jsx(g,{className:"mt-4 h-4 w-32"})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur md:col-span-2",children:[e.jsx(g,{className:"h-5 w-32"}),e.jsx(g,{className:"mt-4 h-48 w-full"})]})]}),l&&e.jsx("div",{className:"mb-4 p-4 bg-red-500/20 border border-red-500/30 rounded-lg",children:e.jsxs("div",{className:"text-red-200 text-sm",children:["Error: ",l]})}),s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-300",children:"Month-to-date Spend"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:"USD"})]}),e.jsx("div",{className:"text-3xl font-semibold text-slate-100",children:w(s.cards.mtdSpendUSD)}),e.jsx("div",{className:"mt-4 jc-glow-line"}),e.jsxs("p",{className:"mt-3 text-xs text-slate-400",children:["Forecast: ",e.jsx("span",{className:"text-slate-200",children:w(s.cards.forecastUSD)})]})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur md:col-span-2",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-300",children:"Spend Trend"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:"USD"})]}),e.jsx(O,{children:e.jsx(c.Suspense,{fallback:e.jsx("div",{className:"h-64 bg-white/5 rounded animate-pulse"}),children:e.jsx(K,{data:((k=s.charts)==null?void 0:k.dailySpend7d)||[],loading:a,timeRange:m})})})]})]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-4 mb-6",children:[e.jsx(c.Suspense,{fallback:e.jsx("div",{className:"h-64 bg-white/5 rounded animate-pulse"}),children:e.jsx(J,{totalSavings:s.savings.totalSavings,optimizationCount:s.savings.optimizationCount,targetSavings:s.savings.targetSavings,topActions:s.savings.topActions,loading:a})}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur md:col-span-2",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-300",children:"Security Findings Trend"}),e.jsx("div",{className:"flex gap-1",children:["guardduty","securityhub","both"].map(d=>e.jsx("button",{onClick:()=>x(d),className:`px-2 py-1 text-xs rounded transition-colors ${u===d?"bg-cyan-500/20 text-cyan-300 border border-cyan-500/30":"bg-white/5 text-slate-400 hover:bg-white/10 border border-white/10"}`,children:d==="both"?"Both":d==="guardduty"?"GuardDuty":"Security Hub"},d))})]}),e.jsx(c.Suspense,{fallback:e.jsx("div",{className:"h-64 bg-white/5 rounded animate-pulse"}),children:e.jsx(G,{data:s.charts.securityFindings7d,loading:a,dataSource:u})})]})]}),e.jsxs("div",{className:"grid md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-300",children:"Active Anomalies"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:"Count"})]}),e.jsx("div",{className:"text-2xl font-bold text-cyan-300",children:s.cards.anomalies30d}),e.jsx("div",{className:"mt-4 jc-glow-line"}),e.jsx("p",{className:"mt-3 text-xs text-slate-400",children:"anomalies detected"})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-300",children:"GuardDuty Findings"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:"Count"})]}),e.jsx("div",{className:"text-2xl font-bold text-cyan-300",children:s.cards.guardDutyFindings7d}),e.jsx("div",{className:"mt-4 jc-glow-line"}),e.jsx("p",{className:"mt-3 text-xs text-slate-400",children:"findings detected"})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-300",children:"Security Hub Controls"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:"Count"})]}),e.jsx("div",{className:"text-2xl font-bold text-cyan-300",children:s.cards.secHubFailedControls7d}),e.jsx("div",{className:"mt-4 jc-glow-line"}),e.jsx("p",{className:"mt-3 text-xs text-slate-400",children:"failed controls"})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-300",children:"Top Services (MTD)"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:"USD"})]}),e.jsxs("ul",{className:"text-sm space-y-2",children:[s.charts.topServicesMTD.slice(0,3).map(d=>e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-slate-200 truncate",children:d.service}),e.jsx("span",{className:"text-slate-400",children:w(d.usd)})]},d.service)),s.charts.topServicesMTD.length===0&&e.jsx("li",{className:"text-slate-400",children:"no data"})]}),e.jsx("div",{className:"mt-4 jc-glow-line"})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsx(c.Suspense,{fallback:e.jsx("div",{className:"h-96 bg-white/5 rounded animate-pulse"}),children:e.jsx(W,{anomalies:s.anomalies,loading:a})}),e.jsx(c.Suspense,{fallback:e.jsx("div",{className:"h-96 bg-white/5 rounded animate-pulse"}),children:e.jsx(q,{findings:s.securityFindings,loading:a})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 mt-6",children:[e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-300",children:"IAM Hygiene"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:"Issues"})]}),e.jsxs("div",{className:"text-sm mb-2",children:["Users without MFA: ",e.jsx("span",{className:"text-cyan-300 font-semibold",children:s.cards.iamUsersWithoutMFA})]}),e.jsxs("div",{className:"text-sm",children:["Keys > 90 days: ",e.jsx("span",{className:"text-cyan-300 font-semibold",children:s.cards.iamKeysOver90d})]}),e.jsx("div",{className:"mt-4 jc-glow-line"})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_0_20px_rgba(0,0,0,0.25)] backdrop-blur",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-300",children:"Network Exposure"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:"Issues"})]}),e.jsxs("div",{className:"text-sm mb-2",children:["Public S3 buckets: ",e.jsx("span",{className:"text-cyan-300 font-semibold",children:s.cards.publicBuckets})]}),e.jsxs("div",{className:"text-sm",children:["Open SG rules: ",e.jsx("span",{className:"text-cyan-300 font-semibold",children:s.cards.openSgRules})]}),e.jsx("div",{className:"mt-4 jc-glow-line"})]})]})]})]})}const de=Object.freeze(Object.defineProperty({__proto__:null,default:Q},Symbol.toStringTag,{value:"Module"}));export{de as M,re as a,ne as b,ae as c,ce as d,w as f,le as g,ie as m};
